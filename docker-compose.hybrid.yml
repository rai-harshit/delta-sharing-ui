# Hybrid Deployment: OSS Delta Sharing Server + Your Admin UI
#
# This configuration uses the battle-tested OSS Delta Sharing Server
# for protocol handling while keeping your Admin UI for management.
#
# Usage:
#   docker-compose -f docker-compose.hybrid.yml up -d
#
# Architecture:
#   - admin-backend: Your Node.js API for admin operations
#   - delta-sharing-oss: Official Delta Sharing Server (Scala/JVM)
#   - nginx: Reverse proxy for routing + audit logging
#   - frontend: Your React admin UI
#   - postgres: Database for recipients, audit logs, etc.

version: '3.8'

services:
  # ===========================================
  # Database
  # ===========================================
  postgres:
    image: postgres:15-alpine
    container_name: delta-sharing-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-delta_sharing}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-delta_sharing}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-delta_sharing}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================
  # Your Admin Backend
  # ===========================================
  admin-backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: delta-sharing-admin
    environment:
      NODE_ENV: production
      PORT: 5000
      DATABASE_URL: postgresql://${POSTGRES_USER:-delta_sharing}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-delta_sharing}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY:?ENCRYPTION_KEY is required}
      
      # Hybrid mode settings
      HYBRID_MODE: "true"
      OSS_CONFIG_PATH: /shared-config
      OSS_SERVER_URL: http://delta-sharing-oss:8080
      
      # Delta Sharing endpoint (what recipients see in credential files)
      DELTA_SHARING_ENDPOINT: ${DELTA_SHARING_ENDPOINT:-http://localhost/delta}
      
      # Cloud storage credentials (also passed to OSS server)
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME:-}
      AZURE_STORAGE_ACCOUNT_KEY: ${AZURE_STORAGE_ACCOUNT_KEY:-}
      AZURE_STORAGE_CONNECTION_STRING: ${AZURE_STORAGE_CONNECTION_STRING:-}
      GCS_PROJECT_ID: ${GCS_PROJECT_ID:-}
    volumes:
      - oss-config:/shared-config
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ===========================================
  # Delta Sharing OSS Server (Scala/JVM)
  # ===========================================
  delta-sharing-oss:
    image: deltaio/delta-sharing-server:0.7.0
    container_name: delta-sharing-oss
    environment:
      # Cloud storage credentials
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AZURE_STORAGE_ACCOUNT_NAME: ${AZURE_STORAGE_ACCOUNT_NAME:-}
      AZURE_STORAGE_ACCOUNT_KEY: ${AZURE_STORAGE_ACCOUNT_KEY:-}
      GOOGLE_APPLICATION_CREDENTIALS: /config/gcs-credentials.json
      
      # JVM settings
      JAVA_OPTS: "-Xmx1g -Xms512m"
    volumes:
      - oss-config:/config:ro
    command: ["--config", "/config/delta-sharing.yaml"]
    depends_on:
      admin-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s  # JVM startup time
    restart: unless-stopped

  # ===========================================
  # Nginx Reverse Proxy (Routing + Audit)
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: delta-sharing-nginx
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.hybrid.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    depends_on:
      - admin-backend
      - delta-sharing-oss
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ===========================================
  # Frontend (Admin UI)
  # ===========================================
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        - VITE_BUILD_MODE=provider
        - VITE_API_URL=/api
        - VITE_DELTA_API_URL=/delta
    container_name: delta-sharing-frontend
    depends_on:
      - nginx
    restart: unless-stopped
    # Frontend is served through nginx, no direct port exposure

  # ===========================================
  # Audit Log Processor (Optional)
  # ===========================================
  # Processes nginx access logs and stores in database
  audit-processor:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
    container_name: delta-sharing-audit
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://${POSTGRES_USER:-delta_sharing}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-delta_sharing}
      AUDIT_LOG_PATH: /var/log/nginx/delta_audit.log
      PROCESS_AUDIT_LOGS: "true"
    volumes:
      - nginx-logs:/var/log/nginx:ro
    command: ["node", "dist/scripts/processAuditLogs.js"]
    depends_on:
      - postgres
      - nginx
    restart: unless-stopped
    profiles:
      - audit  # Only start with: docker-compose --profile audit up

volumes:
  postgres-data:
    driver: local
  oss-config:
    driver: local
  nginx-logs:
    driver: local

networks:
  default:
    name: delta-sharing-network











